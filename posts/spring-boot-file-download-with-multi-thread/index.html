<!doctype html><html lang=cn><head><title>Spring Boot 项目下载文件接口问题 :: liloew 在写字</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="背景 今天组内研发同学报告说项目中有一个模块提供了文件下载的接口, 在实际使用中遇到有客户使用 迅雷 进行离线下载的情况, 同时模块中针对文件下载的接口做了 AOP 切面进行计费统计. 而 迅雷 会针对该接口进行多线程并发下载, 同时即使退出 迅雷, 迅雷 的调用还在继续 - 现象是即使退出 迅雷, 迅雷 仍然在 后台 发起对文件下载接口的调用. 抽空大致看来下项目内的代码, 出问题的接口功能也比较简单, 并没有很复杂的逻辑. 其大致实现如下:
"><meta name=keywords content=","><meta name=robots content="noodp"><link rel=canonical href=https://liloew.github.io/posts/spring-boot-file-download-with-multi-thread/><link rel=stylesheet href=https://liloew.github.io/styles.css><link rel="shortcut icon" href=https://liloew.github.io/img/theme-colors/green.png><link rel=apple-touch-icon href=https://liloew.github.io/img/theme-colors/green.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content><meta property="og:locale" content="cn"><meta property="og:type" content="article"><meta property="og:title" content="Spring Boot 项目下载文件接口问题"><meta property="og:description" content="背景 今天组内研发同学报告说项目中有一个模块提供了文件下载的接口, 在实际使用中遇到有客户使用 迅雷 进行离线下载的情况, 同时模块中针对文件下载的接口做了 AOP 切面进行计费统计. 而 迅雷 会针对该接口进行多线程并发下载, 同时即使退出 迅雷, 迅雷 的调用还在继续 - 现象是即使退出 迅雷, 迅雷 仍然在 后台 发起对文件下载接口的调用. 抽空大致看来下项目内的代码, 出问题的接口功能也比较简单, 并没有很复杂的逻辑. 其大致实现如下:
"><meta property="og:url" content="https://liloew.github.io/posts/spring-boot-file-download-with-multi-thread/"><meta property="og:site_name" content="liloew 在写字"><meta property="og:image" content="https://liloew.github.io"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2023-02-26 21:26:48 +0800 +0800"></head><body class=green><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Terminal</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/showcase>Showcase</a></li><li><a href=/about>关于</a></li><hr><li><a href=https://liloew.github.io/>简中</a></li><li><a href=https://liloew.github.io/en/>English</a></li></ul></li></ul><ul class="menu menu--desktop menu--language-selector"><li class=menu__trigger>简中&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://liloew.github.io/>简中</a></li><li><a href=https://liloew.github.io/en/>English</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/showcase>Showcase</a></li><li><a href=/about>关于</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://liloew.github.io/posts/spring-boot-file-download-with-multi-thread/>Spring Boot 项目下载文件接口问题</a></h1><div class=post-meta><time class=post-date>2023-02-26 ::</time></div><span class=post-tags>#<a href=https://liloew.github.io/tags/spring/>Spring</a>&nbsp;
#<a href=https://liloew.github.io/tags/spring-boot/>Spring Boot</a>&nbsp;
#<a href=https://liloew.github.io/tags/java/>Java</a>&nbsp;
#<a href=https://liloew.github.io/tags/debug/>Debug</a>&nbsp;</span><div class=post-content><div><h1 id=背景>背景<a href=#背景 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>今天组内研发同学报告说项目中有一个模块提供了文件下载的接口, 在实际使用中遇到有客户使用 <code>迅雷</code> 进行离线下载的情况, 同时模块中针对文件下载的接口做了 <code>AOP</code> 切面进行计费统计. 而 <code>迅雷</code> 会针对该接口进行多线程并发下载, 同时即使退出 <code>迅雷</code>, <code>迅雷</code> 的调用还在继续 - 现象是即使退出 <code>迅雷</code>, <code>迅雷</code> 仍然在 <code>后台</code> 发起对文件下载接口的调用. 抽空大致看来下项目内的代码, 出问题的接口功能也比较简单, 并没有很复杂的逻辑. 其大致实现如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span>    <span style=color:#a6e22e>@ApiOperation</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;下载文件模板&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/download/{y}/{m}/{d}/{filePath}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ResponseEntity<span style=color:#f92672>&lt;</span>FileSystemResource<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>download</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@PathVariable</span> String y<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                                       <span style=color:#a6e22e>@PathVariable</span> String m<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                                       <span style=color:#a6e22e>@PathVariable</span> String d<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                                       <span style=color:#a6e22e>@PathVariable</span> String filePath<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        filePath <span style=color:#f92672>=</span> y <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> m <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> d <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> filePath<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> HBFileUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>downloadFile</span><span style=color:#f92672>(</span>fileManageService<span style=color:#f92672>.</span><span style=color:#a6e22e>download</span><span style=color:#f92672>(</span>filePath<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>----</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> ResponseEntity <span style=color:#a6e22e>downloadFile</span><span style=color:#f92672>(</span>File file<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>file<span style=color:#f92672>.</span><span style=color:#a6e22e>isFile</span><span style=color:#f92672>()</span> <span style=color:#f92672>||</span> FileUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>(</span>file<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            ResultVO notFound <span style=color:#f92672>=</span> ResultUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span>HttpStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>NOT_FOUND</span><span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>(),</span> HttpStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>NOT_FOUND</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getReasonPhrase</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> ResponseEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>status</span><span style=color:#f92672>(</span>HttpStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>NOT_FOUND</span><span style=color:#f92672>).</span><span style=color:#a6e22e>body</span><span style=color:#f92672>(</span>notFound<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        HttpHeaders headers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpHeaders<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        headers<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cache-Control&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;no-cache, no-store, must-revalidate&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        headers<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Content-Disposition&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;attachment; filename=&#34;</span> <span style=color:#f92672>+</span> file<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        headers<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Pragma&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;no-cache&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        headers<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Expires&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;0&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        headers<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Last-Modified&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Date<span style=color:#f92672>().</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        headers<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ETag&#34;</span><span style=color:#f92672>,</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>valueOf</span><span style=color:#f92672>(</span>System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ResponseEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>headers</span><span style=color:#f92672>(</span>headers<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>contentLength</span><span style=color:#f92672>(</span>file<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>contentType</span><span style=color:#f92672>(</span>MediaType<span style=color:#f92672>.</span><span style=color:#a6e22e>APPLICATION_OCTET_STREAM</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> FileSystemResource<span style=color:#f92672>(</span>file<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=排查---1>排查 - 1<a href=#排查---1 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>首先的疑问便是 <code>迅雷</code> 果不其然如此暴力, 但转念一想也不应该. 即使 <code>迅雷</code> 以流氓著称, 但其核心还是进行多线程下载. 而多线程下载的前提是下载接口支持分片, 显然模块内接口是不支持的. 所以这个问题应该不那么简单.</p><h1 id=排查---2>排查 - 2<a href=#排查---2 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>首先是起了一个 <code>DEMO</code> 工程, 参照现有模块中文件下载接口 <code>Mock</code> 了一个类似的接口:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span>path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/download&#34;</span><span style=color:#f92672>,</span> method <span style=color:#f92672>=</span> RequestMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>GET</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>downadFileGET</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestParam</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>,</span> required <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> defaultValue <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1&#34;</span><span style=color:#f92672>)</span> String fileId<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            HttpServletResponse response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        FileDownloadBO fileDownloadBO <span style=color:#f92672>=</span> FileDownloadBO<span style=color:#f92672>.</span><span style=color:#a6e22e>builder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>(</span>fileId<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;下载开始: {} 时间: {}&#34;</span><span style=color:#f92672>,</span> fileDownloadBO<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>(),</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            File file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>fileService<span style=color:#f92672>.</span><span style=color:#a6e22e>checkFile</span><span style=color:#f92672>(</span>fileDownloadBO<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            BufferedInputStream is <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BufferedInputStream<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> FileInputStream<span style=color:#f92672>(</span>file<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            response<span style=color:#f92672>.</span><span style=color:#a6e22e>setHeader</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cache-Control&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;no-cache, no-store, must-revalidate&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            response<span style=color:#f92672>.</span><span style=color:#a6e22e>setHeader</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Content-Disposition&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;attachment; filename=&#34;</span> <span style=color:#f92672>+</span> file<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            response<span style=color:#f92672>.</span><span style=color:#a6e22e>setHeader</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Pragma&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;no-cache&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            response<span style=color:#f92672>.</span><span style=color:#a6e22e>setHeader</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Expires&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;0&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            response<span style=color:#f92672>.</span><span style=color:#a6e22e>setHeader</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Last-Modified&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Date<span style=color:#f92672>().</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            response<span style=color:#f92672>.</span><span style=color:#a6e22e>setHeader</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ETag&#34;</span><span style=color:#f92672>,</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>valueOf</span><span style=color:#f92672>(</span>System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>            response<span style=color:#f92672>.</span><span style=color:#a6e22e>setContentLengthLong</span><span style=color:#f92672>(</span>file<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            response<span style=color:#f92672>.</span><span style=color:#a6e22e>setContentType</span><span style=color:#f92672>(</span>MediaType<span style=color:#f92672>.</span><span style=color:#a6e22e>APPLICATION_OCTET_STREAM_VALUE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            IOUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>copy</span><span style=color:#f92672>(</span>is<span style=color:#f92672>,</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>getOutputStream</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            response<span style=color:#f92672>.</span><span style=color:#a6e22e>flushBuffer</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;下载成功: {} 时间: {}&#34;</span><span style=color:#f92672>,</span> fileDownloadBO<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>(),</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;拷贝文件流异常: {} 时间: {}&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>(),</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;下载结束: {} 时间: {}&#34;</span> <span style=color:#f92672>,</span> fileDownloadBO<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>(),</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>通过 <code>curl</code> 测试可正常下载文件:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export CURL<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/usr/bin/curl&#34;</span>
</span></span><span style=display:flex><span>export BASE_URL<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://192.168.1.4:8080&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>CURL<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -X GET <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BASE_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>/v1/file/download&#34;</span>
</span></span></code></pre></div><p>再通过 <code>axel</code> 工具进行测试, 发现 <code>axel</code> 指出该接口不支持多线程下载并切换为单线程下载:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export AXEL<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/usr/bin/axel&#34;</span>
</span></span><span style=display:flex><span>export BASE_URL<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://192.168.1.4:8080&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>AXEL<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -v -n <span style=color:#ae81ff>20</span> -o f.f <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BASE_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>/v1/file/download&#34;</span>
</span></span></code></pre></div><p>输出如下:</p><pre tabindex=0><code>Initializing download: http://192.168.1.3:8080/v1/file/download
File size: 173.246 Megabyte(s) (181661264 bytes)
Opening output file f.f
Server unsupported, starting from scratch with one connection.
Starting download

[ 12%] [....0                                 ] [  10.2MB/s] [00:14]
</code></pre><p>对应的服务端日志为:</p><pre tabindex=0><code>2023-02-24 09:47:16.001  INFO 80611 --- [nio-8080-exec-4] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203236001
2023-02-24 09:47:16.003 ERROR 80611 --- [nio-8080-exec-4] c.e.d.controller.FileController          : 拷贝文件流异常: java.io.IOException: Broken pipe 时间: 1677203236003
2023-02-24 09:47:16.003  INFO 80611 --- [nio-8080-exec-4] c.e.d.controller.FileController          : 下载结束: 1 时间: 1677203236003
2023-02-24 09:47:16.006  INFO 80611 --- [nio-8080-exec-5] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203236006
</code></pre><p>可以明显看到 <code>axel</code> 调用了两次文件下载接口. 这是符合预期的, 因为服务端不支持分片/断点下载, 所以 <code>axel</code> 在尝试分片失败后切换为常规单线程下载.</p><h1 id=排查---3>排查 - 3<a href=#排查---3 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>经与模块内有问题的代码进行对比发现区别较大的地方在于:</p><pre tabindex=0><code>一个是接口的返回类型, 有问题的接口返回的是 `ResponseEntity`, 而正常的接口无返回值; 也正因为此, 有问题的接口通过 ResponseEntity 通过 body 参数返回, 而正常的接口则通过 IO 流拷贝的形式传输数据.
</code></pre><p>因此同样 <code>Mock</code> 了一个返回类型为 <code>ResponseEntity</code> 的接口如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span>path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/downloadR&#34;</span><span style=color:#f92672>,</span> method <span style=color:#f92672>=</span> RequestMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>GET</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ResponseEntity <span style=color:#a6e22e>downloadFileGETResponseEntity</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestParam</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>,</span> required <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> defaultValue <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1&#34;</span><span style=color:#f92672>)</span> String fileId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        FileDownloadBO fileDownloadBO <span style=color:#f92672>=</span> FileDownloadBO<span style=color:#f92672>.</span><span style=color:#a6e22e>builder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>(</span>fileId<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;下载开始: {} 时间: {}&#34;</span><span style=color:#f92672>,</span> fileDownloadBO<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>(),</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        File file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>fileService<span style=color:#f92672>.</span><span style=color:#a6e22e>checkFile</span><span style=color:#f92672>(</span>fileDownloadBO<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        HttpHeaders headers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpHeaders<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        headers<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cache-Control&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;no-cache, no-store, must-revalidate&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        headers<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Content-Disposition&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;attachment; filename=&#34;</span> <span style=color:#f92672>+</span> file<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        headers<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Pragma&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;no-cache&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        headers<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Expires&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;0&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        headers<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Last-Modified&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Date<span style=color:#f92672>().</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        headers<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ETag&#34;</span><span style=color:#f92672>,</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>valueOf</span><span style=color:#f92672>(</span>System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        ResponseEntity res <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            res <span style=color:#f92672>=</span> ResponseEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>headers</span><span style=color:#f92672>(</span>headers<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>contentLength</span><span style=color:#f92672>(</span>file<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>contentType</span><span style=color:#f92672>(</span>MediaType<span style=color:#f92672>.</span><span style=color:#a6e22e>APPLICATION_OCTET_STREAM</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> FileSystemResource<span style=color:#f92672>(</span>file<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> res<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>同样分别通过 <code>curl</code> 和 <code>axel</code> 针对该接口进行测试发现, <code>axel</code> 接口在该接口上进行了多线程并发下载, <code>axel</code> 的输出如下:</p><pre tabindex=0><code>Initializing download: http://192.168.1.3:8080/v1/file/downloadR
File size: 173.246 Megabyte(s) (181661264 bytes)
Opening output file f.f
Starting download

[  9%] [.01.2.3.45 6 7 8 9A B C D E F G H I J ] [  10.1MB/s] [00:15]
</code></pre><p>同时也可看到服务端日志也明确说明该接口被进行了多次调用:</p><pre tabindex=0><code>2023-02-24 09:56:05.877  INFO 80611 --- [nio-8080-exec-7] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765877
2023-02-24 09:56:05.882  INFO 80611 --- [nio-8080-exec-8] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765882
2023-02-24 09:56:05.882  INFO 80611 --- [nio-8080-exec-9] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765882
2023-02-24 09:56:05.882  INFO 80611 --- [nio-8080-exec-1] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765882
2023-02-24 09:56:05.882  INFO 80611 --- [nio-8080-exec-2] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765882
2023-02-24 09:56:05.882  INFO 80611 --- [io-8080-exec-10] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765882
2023-02-24 09:56:05.883  INFO 80611 --- [nio-8080-exec-3] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765883
2023-02-24 09:56:05.884  INFO 80611 --- [nio-8080-exec-4] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765884
2023-02-24 09:56:05.884  INFO 80611 --- [nio-8080-exec-5] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765884
2023-02-24 09:56:05.885  INFO 80611 --- [io-8080-exec-11] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765885
2023-02-24 09:56:05.886  INFO 80611 --- [nio-8080-exec-7] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765886
2023-02-24 09:56:05.885  INFO 80611 --- [nio-8080-exec-6] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765885
2023-02-24 09:56:05.889  INFO 80611 --- [io-8080-exec-13] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765889
2023-02-24 09:56:05.893  INFO 80611 --- [io-8080-exec-14] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765893
2023-02-24 09:56:05.894  INFO 80611 --- [io-8080-exec-15] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765894
2023-02-24 09:56:05.897  INFO 80611 --- [io-8080-exec-16] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765897
2023-02-24 09:56:05.900  INFO 80611 --- [io-8080-exec-17] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765900
2023-02-24 09:56:05.901  INFO 80611 --- [io-8080-exec-18] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765901
2023-02-24 09:56:05.903  INFO 80611 --- [io-8080-exec-19] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765903
2023-02-24 09:56:05.908  INFO 80611 --- [io-8080-exec-20] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765908
2023-02-24 09:56:05.886  INFO 80611 --- [io-8080-exec-12] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677203765886
</code></pre><h1 id=分析---1>分析 - 1<a href=#分析---1 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>至此问题便比较清晰了, 如果使用 <code>ResponseEntity</code> 的话客户端就会误认为该接口支持分片下载, 而如果直接通过 <code>IO</code> 流进行拷贝的话则不会有这个问题. 那么为什么会导致这个问题呢, 是哪里让客户端误认为服务器支持分片下载呢 ? 首先想到的可能便是服务端在返回时通过 <code>Header</code> 告诉客户端该接口是支持分片下载的, 通过 <code>curl</code> 的 <code>-v</code> 参数可以看到请求和响应头:
以下内容是正常接口的请求和响应头:</p><pre tabindex=0><code>* TCP_NODELAY set
* Connected to 192.168.1.3 (192.168.1.3) port 8080 (#0)
&gt; GET /v1/file/download HTTP/1.1
&gt; Host: 192.168.1.3:8080
&gt; User-Agent: curl/7.64.1
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200
&lt; Cache-Control: no-cache, no-store, must-revalidate
&lt; Content-Disposition: attachment; filename=small.data
&lt; Pragma: no-cache
&lt; Expires: 0
&lt; Last-Modified: Fri Feb 24 10:21:14 CST 2023
&lt; ETag: 1677205274463
&lt; Content-Type: application/octet-stream
&lt; Content-Length: 181661264
&lt; Date: Fri, 24 Feb 2023 02:21:14 GMT
&lt;
</code></pre><p>以下内容是客户端误认为支持分片下载的请求和响应头:</p><pre tabindex=0><code>&gt; GET /v1/file/downloadR HTTP/1.1
&gt; Host: 192.168.1.3:8080
&gt; User-Agent: curl/7.64.1
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200
&lt; ETag: &#34;1677205253508&#34;
&lt; Cache-Control: no-cache, no-store, must-revalidate
&lt; Content-Disposition: attachment; filename=large.data
&lt; Pragma: no-cache
&lt; Expires: 0
&lt; Accept-Ranges: bytes
&lt; Content-Type: application/octet-stream
&lt; Content-Length: 181661264
&lt; Date: Fri, 24 Feb 2023 02:20:53 GMT
&lt;
</code></pre><p>我们主要分析响应部分, 通过对比可以发现有问题的接口在响应头里多了一个 <code>Accept-Ranges: bytes</code>, 很明显该 <code>Header</code> 是用于分片/断点下载的.
而分析上面的代码可以看到没有配置该 <code>Header</code>, 那么是哪里添加了该内容呢 ? 不难想到应该是 <code>Spring</code> 替我们做了这些事情, 那么如何知道 <code>Spring</code> 是在哪一步为我们做这些事情的呢 ?</p><h1 id=继续分析>继续分析<a href=#继续分析 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>我们通过在 <code>application.properities</code> 文件中中增加 <code>debug=true</code> 配置来查看在我们的 <code>Controller</code> <code>return</code> 以后还走了哪些路径. 此时我们仍然通过 <code>curl</code> 进行调用而不再使用支持断点续传的客户端以免产生多次调用影响我们的分析进程. 我们只关心 <code>Controller</code> 返回以后的逻辑, 故服务端日志如下:</p><pre tabindex=0><code>2023-02-24 10:28:41.202  INFO 81955 --- [nio-8080-exec-1] c.e.d.controller.FileController          : 下载开始: 1 时间: 1677205721202
2023-02-24 10:28:41.218 DEBUG 81955 --- [nio-8080-exec-1] o.s.w.s.m.m.a.HttpEntityMethodProcessor  : Found &#39;Content-Type:application/octet-stream&#39; in response
2023-02-24 10:28:41.218 DEBUG 81955 --- [nio-8080-exec-1] o.s.w.s.m.m.a.HttpEntityMethodProcessor  : Writing [file [/tmp/large.data]]
2023-02-24 10:28:41.232 DEBUG 81955 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Failed to complete request: org.apache.catalina.connector.ClientAbortException: java.io.IOException: Broken pipe
</code></pre><p>最后一行报错亦可忽略, 这是因为 <code>curl</code> 不支持文件下载的原因(仅测试, 未完全配置). 通过以上日志可以看到, 在我们的 <code>Controller</code> 返回后, 还额外走了 <code>HttpEntityMethodProcessor</code> 两部分的逻辑. 在 <code>HttpEntityMethodProcessor</code> 内通过相关的关键字没有匹配到具体的代码, 但 <code>HttpEntityMethodProcessor</code> 继承自 <code>AbstractMessageConverterMethodProcessor</code>, 最终我们在 <code>AbstractMessageConverterMethodProcessor</code> 内通过 <code>Found</code>, <code>Writing</code> 关键字可定位具体的代码. 由于 <code>Spring</code> 替我们增加了 <code>Accept-Ranges: bytes</code> 头, 因此我们再通过 <code>bytes</code> 关键字
最终我们定位到在 <code>AbstractMessageConverterMethodProcessor.java</code> 文件中有我们想要的内容:
, 在其中搜索 <code>bytes</code> 便可找到如下代码:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isResourceType<span style=color:#f92672>(</span>value<span style=color:#f92672>,</span> returnType<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			outputMessage<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeaders</span><span style=color:#f92672>().</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>HttpHeaders<span style=color:#f92672>.</span><span style=color:#a6e22e>ACCEPT_RANGES</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;bytes&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>value <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> inputMessage<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeaders</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getFirst</span><span style=color:#f92672>(</span>HttpHeaders<span style=color:#f92672>.</span><span style=color:#a6e22e>RANGE</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>					outputMessage<span style=color:#f92672>.</span><span style=color:#a6e22e>getServletResponse</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getStatus</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				Resource resource <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Resource<span style=color:#f92672>)</span> value<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>					List<span style=color:#f92672>&lt;</span>HttpRange<span style=color:#f92672>&gt;</span> httpRanges <span style=color:#f92672>=</span> inputMessage<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeaders</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getRange</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>					outputMessage<span style=color:#f92672>.</span><span style=color:#a6e22e>getServletResponse</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setStatus</span><span style=color:#f92672>(</span>HttpStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>PARTIAL_CONTENT</span><span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>					body <span style=color:#f92672>=</span> HttpRange<span style=color:#f92672>.</span><span style=color:#a6e22e>toResourceRegions</span><span style=color:#f92672>(</span>httpRanges<span style=color:#f92672>,</span> resource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>					valueType <span style=color:#f92672>=</span> body<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>					targetType <span style=color:#f92672>=</span> RESOURCE_REGION_LIST_TYPE<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IllegalArgumentException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>					outputMessage<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeaders</span><span style=color:#f92672>().</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>HttpHeaders<span style=color:#f92672>.</span><span style=color:#a6e22e>CONTENT_RANGE</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;bytes */&#34;</span> <span style=color:#f92672>+</span> resource<span style=color:#f92672>.</span><span style=color:#a6e22e>contentLength</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>					outputMessage<span style=color:#f92672>.</span><span style=color:#a6e22e>getServletResponse</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setStatus</span><span style=color:#f92672>(</span>HttpStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>REQUESTED_RANGE_NOT_SATISFIABLE</span><span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>至此, 可以知道确实是 <code>Spring</code> 为我们主动做了这件事, 如何解决呢 ?
可以看到这部分有一个前置条件:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span>	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isResourceType</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> Object value<span style=color:#f92672>,</span> MethodParameter returnType<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		Class<span style=color:#f92672>&lt;?&gt;</span> clazz <span style=color:#f92672>=</span> getReturnValueType<span style=color:#f92672>(</span>value<span style=color:#f92672>,</span> returnType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> clazz <span style=color:#f92672>!=</span> InputStreamResource<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span> <span style=color:#f92672>&amp;&amp;</span> Resource<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>clazz<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>因此一个解决方案便是输出流使用 <code>InputStreamResource</code> 而不是 <code>FileSystemResource</code>. 至于为何修改该判断条件的前半段, 即:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span>clazz <span style=color:#f92672>!=</span> InputStreamResource<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span>
</span></span></code></pre></div><p>而非后半段呢 ? 原因在于 <code>FileSystemResource</code> 和 <code>InputStreamResource</code> 都继承自 <code>AbstractResource</code>, 而 <code>AbstractResource</code> 则继承自 <code>Resource</code>.</p><p>修改后的代码如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span>            res <span style=color:#f92672>=</span> ResponseEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>headers</span><span style=color:#f92672>(</span>headers<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>contentLength</span><span style=color:#f92672>(</span>file<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>contentType</span><span style=color:#f92672>(</span>MediaType<span style=color:#f92672>.</span><span style=color:#a6e22e>APPLICATION_OCTET_STREAM</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> InputStreamResource<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> FileInputStream<span style=color:#f92672>(</span>file<span style=color:#f92672>)));</span>
</span></span></code></pre></div><h1 id=补充>补充<a href=#补充 class=hanchor arialabel=Anchor>&#8983;</a></h1><ol><li><p>以上修改后 <code>axel</code> 不再进行多线程下载了, 但 <code>迅雷</code> 还是会进行多线程下载. 经多次测试发现, 如果响应头中包含 <code>Content-Length</code> 则迅雷还是会进行多线程下载. 解决方案是不再设置该 <code>Header</code>. 另一点需要注意是, 如果不设置 <code>Content-Length</code> 则 <code>Nginx</code> 会自动为我们加上 <code>Transfer-Encoding: chunked</code> 头. 根据定义可知 <code>Transfer-Encoding</code> 和 <code>Content-Length</code> 是不兼容的.</p></li><li><p>通过以上排查路径可以知道, 这里关键的问题在于服务端在给客户端的响应头里额外增加了 <code>Accept-Ranges: bytes</code>, 如在一些不便于修改代码的场景下也可以通过 <code>Nginx</code> 将部分响应头去除的方式修复.</p><p>2.1. 使用 <code>openresty/openresty</code> 镜像代替默认的 <code>nginx</code>;</p><p>2.2. 相对于原始的 <code>nginx</code> 配置文件做如下修改:</p><pre tabindex=0><code># nginx.conf 中添加
load_module &#34;modules/ngx_http_headers_more_filter_module.so&#34;;

# 在 server 的 location 段落中添加
more_clear_headers &#39;Accept-Ranges&#39;;
more_clear_headers &#39;Content-Length&#39;;
</code></pre><p><code>axel</code> 在移除 <code>Accept-Ranges</code> 即不再进行多线程下载, 但 <code>迅雷</code> 在检测到 <code>Content-Length</code> 响应头后依然会发起多线程进行下载.</p><p>2.3. 重启容器即可;</p></li><li><p>也可使用 <code>debian</code> 容器中安装 <code>nginx-extras</code> 包来应用 <code>headers_more_filter</code> 模块:</p></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> debian:latest</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> sed -i <span style=color:#e6db74>&#39;s/deb.debian.org/mirrors.ustc.edu.cn/g&#39;</span> /etc/apt/sources.list <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    apt-get update -y <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    apt-get install nginx nginx-extras -y <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    rm -rf /var/lib/apt/lists/*<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;nginx&#34;</span>, <span style=color:#e6db74>&#34;-g&#34;</span>, <span style=color:#e6db74>&#34;daemon off;&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h1 id=ref>REF<a href=#ref class=hanchor arialabel=Anchor>&#8983;</a></h1><ol><li><a href=https://github.com/spring-projects/spring-framework/commit/582014e944002609b562f6e4998935c06bbe6922>Support HTTP range requests in MVC Controllers</a></li><li><a href=https://stackoverflow.com/questions/2419281/content-length-header-versus-chunked-encoding>Content-Length header versus chunked encoding</a></li></ol></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2023 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>