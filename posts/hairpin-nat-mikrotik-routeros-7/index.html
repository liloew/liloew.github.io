<!doctype html><html lang=cn><head><title>解决 MikroTik RouterOS 下 NAT 回环问题 :: liloew 在写字</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="背景 前段时间通过客服拿到了联通的公网 IP, 因此也申请了域名并做了解析, 也顺利应当地在路由器上做了端口映射, 从而可以在外网可以直接通过域名加端口的形式访问内网的服务. 但也有一个问题就是当处于内网环境时通过域名反而无法访问同一内网下的服务, 必须使用内网 IP 才行.
其实这个问题很明显, 就是网络报文在通过路由器时路由器将报文转发给了内网服务器, 但是内网服务器在回报文的时候直接按内网地址回包了. 这个问题由来已久, 也即 NAT 回环问题. 以下我们将通过脚本的形式在 RouterOS 上添加 NAT 规则来解决这个 NAT 回环问题.
具体环境为光猫配置了桥接后通过 MikroTik RB750Gr3 进行拨号, 同时 RB750Gr3 运行的 RouterOS 版本为 7.7, 并且内网网段为 192.168.2.0/24.
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.liloew.in/posts/hairpin-nat-mikrotik-routeros-7/><link rel=stylesheet href=https://blog.liloew.in/styles.css><link rel="shortcut icon" href=https://blog.liloew.in/img/theme-colors/green.png><link rel=apple-touch-icon href=https://blog.liloew.in/img/theme-colors/green.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content><meta property="og:locale" content="cn"><meta property="og:type" content="article"><meta property="og:title" content="解决 MikroTik RouterOS 下 NAT 回环问题"><meta property="og:description" content="背景 前段时间通过客服拿到了联通的公网 IP, 因此也申请了域名并做了解析, 也顺利应当地在路由器上做了端口映射, 从而可以在外网可以直接通过域名加端口的形式访问内网的服务. 但也有一个问题就是当处于内网环境时通过域名反而无法访问同一内网下的服务, 必须使用内网 IP 才行.
其实这个问题很明显, 就是网络报文在通过路由器时路由器将报文转发给了内网服务器, 但是内网服务器在回报文的时候直接按内网地址回包了. 这个问题由来已久, 也即 NAT 回环问题. 以下我们将通过脚本的形式在 RouterOS 上添加 NAT 规则来解决这个 NAT 回环问题.
具体环境为光猫配置了桥接后通过 MikroTik RB750Gr3 进行拨号, 同时 RB750Gr3 运行的 RouterOS 版本为 7.7, 并且内网网段为 192.168.2.0/24.
"><meta property="og:url" content="https://blog.liloew.in/posts/hairpin-nat-mikrotik-routeros-7/"><meta property="og:site_name" content="liloew 在写字"><meta property="og:image" content="https://blog.liloew.in/img/favicon/green.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2023-05-16 17:31:12 +0800 +0800"><meta name=google-site-verification content="o7XjncKCMp0WON8AzwzxbzEUpfS9BiR6I94Hao6szK0"></head><body class=green><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Terminal</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/books>书</a></li><li><a href=/about>关于</a></li><hr><li><a href=https://blog.liloew.in/>简中</a></li><li><a href=https://blog.liloew.in/en/>English</a></li></ul></li></ul><ul class="menu menu--desktop menu--language-selector"><li class=menu__trigger>简中&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://blog.liloew.in/>简中</a></li><li><a href=https://blog.liloew.in/en/>English</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/books>书</a></li><li><a href=/about>关于</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.liloew.in/posts/hairpin-nat-mikrotik-routeros-7/>解决 MikroTik RouterOS 下 NAT 回环问题</a></h1><div class=post-meta><time class=post-date>2023-05-16</time></div><span class=post-tags>#<a href=https://blog.liloew.in/tags/hairpin/>Hairpin</a>&nbsp;
#<a href=https://blog.liloew.in/tags/nat/>NAT</a>&nbsp;
#<a href=https://blog.liloew.in/tags/mikrotik/>MikroTik</a>&nbsp;
#<a href=https://blog.liloew.in/tags/routeros/>RouterOS</a>&nbsp;</span><div class=post-content><div><h1 id=背景>背景<a href=#背景 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>前段时间通过客服拿到了联通的公网 <code>IP</code>, 因此也申请了域名并做了解析, 也顺利应当地在路由器上做了端口映射, 从而可以在外网可以直接通过域名加端口的形式访问内网的服务. 但也有一个问题就是当处于内网环境时通过域名反而无法访问同一内网下的服务, 必须使用内网 <code>IP</code> 才行.</p><p>其实这个问题很明显, 就是网络报文在通过路由器时路由器将报文转发给了内网服务器, 但是内网服务器在回报文的时候直接按内网地址回包了. 这个问题由来已久, 也即 <code>NAT</code> 回环问题. 以下我们将通过脚本的形式在 <code>RouterOS</code> 上添加 <code>NAT</code> 规则来解决这个 <code>NAT</code> 回环问题.</p><p>具体环境为光猫配置了桥接后通过 <code>MikroTik</code> <code>RB750Gr3</code> 进行拨号, 同时 <code>RB750Gr3</code> 运行的 <code>RouterOS</code> 版本为 <code>7.7</code>, 并且内网网段为 <code>192.168.2.0/24</code>.</p><h1 id=步骤>步骤<a href=#步骤 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>首先假设我们拥有公网 <code>IP</code> 为 <code>1.2.3.4</code>, 现在新建一条 <code>NAT</code> 规则用于将内网服务暴露到外网:</p><pre tabindex=0><code>/ip firewall nat add chain=dstnat dst-address-type=local protocol=tcp dst-port=18080 action=dst-nat to-addresses=192.168.2.123 to-ports=8080 comment=&#34;Vaultwarden&#34;
</code></pre><p>这里新建规则意思是当访问 <code>1.2.3.4:18080</code> 上的服务时将其转发到内网的 <code>192.168.2.123:8080</code> 端口上. 在添加完这条规则后我们可以通过外网测试访问是否成功, 如无外网环境则可以通过蜂窝网络进行测试.</p><p>当确认以上端口转发规则没有问题后, 现在可以再新建一条用于解决 <code>NAT</code> 回环的规则, 在 <code>MikroTik</code> 官方文档中则被称为 <code>Hairpin NAT</code>:</p><pre tabindex=0><code>/ip firewall nat add chain=srcnat src-address=192.168.2.0/24 dst-address=192.168.2.0/24 protocol=tcp out-interface-list=LAN action=masquerade comment=&#34;Hairpin-NAT&#34;
</code></pre><p>这里我们新建的规则是当匹配到 <code>SRC</code> 和 <code>DST</code> 地址都为 <code>192.168.2.0/24</code> 网段下时则进行 <code>masquerade</code> 地址伪装, 而网上不上针对 <code>NAT</code> 回环规则则匹配端口从而导致如果有多条端口转发规则时需要配置对应数量的 <code>NAT</code> 回环规则, 因此我们这里通过匹配 <code>SRC</code> 和 <code>DST</code> 地址的形式来最大化复用该规则. 此时在内网环境下已经可以通过公网 <code>IP</code> 或域名的形式访问同一内网下的服务了, 从而实现内外网访问地址的统一, 避免了频繁切换地址的问题.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://blog.liloew.in/posts/rust-implementation-dhcp-1/><span class=button__icon>←</span>
<span class=button__text>DHCP 协议分析及实现 - Ⅰ</span></a></span>
<span class="button next"><a href=https://blog.liloew.in/posts/compile-qemu-on-centos-8-with-macos-support/><span class=button__text>在 CentOS 8 下编译 QEMU 以支持运行 macOS 虚拟机</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script>
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "830a0d98b04b48168572244940312993"}'></script>
<script type=text/javascript>var sc_project=12967808,sc_invisible=1,sc_security="a1111881"</script><script type=text/javascript src=https://www.statcounter.com/counter/counter.js async></script><noscript><div class=statcounter><a title="Web Analytics" href=https://statcounter.com/ target=_blank><img class=statcounter src=https://c.statcounter.com/12967808/0/a1111881/1/ alt="Web Analytics" referrerpolicy=no-referrer-when-downgrade></a></div></noscript></div></body></html>